# This file can be used with https://sequencediagram.org/
# And rendered to an image file

title fEMR Authentication Sequence with OpenID Connect

participant "User's Browser (User-Agent)" as UserAgent
participant "fEMR Dashboard OIDC client (Relying Party)" as RP
participant "Keycloak OIDC Provider (OP)" as OP


note over UserAgent: User visits https:\/\/dashboard.cosri.app
UserAgent->RP: GET https:\/\/dashboard.cosri.app/


# flask-oidc uses deploy-specific config values instead of introspecting .well-known/
RP->OP: GET https:\/\/keycloak.cosri.app/.well-known/openid-configuration
OP->RP: JSON meta-data document
note left of OP:JSON meta-data document:\n{\n    "token_endpoint": "https:\/\/keycloak.cosri.app//auth/realms/fEMR/protocol/openid-connect/token", \n    "authorization_endpoint":"https:\/\/keycloak.cosri.app/authorize?...",\n    ...\n}

RP->UserAgent: 302 Redirect to https:\/\/keycloak.cosri.app/authorize?[...]

note left of RP:GET /authorize parameters:\nstate=xxx (CSRF protection)\nnonce=xxx (server-side replay protection)\nscope=openid email profile\nredirect_uri=https:\/\/dashboard.cosri.app/oidc_callback (OP will redirect here)\nresponse_type=code\nclient_id=xxx (RP identifier)


UserAgent->OP: GET https:\/\/keycloak.cosri.app/authorize?[...]
OP->UserAgent: Show hosted login page
UserAgent->OP: Performs login
OP->UserAgent: 302 Redirect to https:\/\/dashboard.cosri.app/oidc_callback?[...] (redirect_uri)

note left of RP:GET /callback parameters:\nstate=xxx\ncode=xxx

UserAgent->RP: GET https:\/\/dashboard.cosri.app/oidc_callback?[...]
RP->OP: POST https:\/\/keycloak.cosri.app/oauth/token

note right of RP:POST /oauth/token parameters:\nclient_id=xxx\nclient_secret=xxx (secret identifying the RP to the OP)\ngrant_type=authorization_code\ncode=xxx\nstate=xxx


OP->RP: JSON {"base64(id_token)", "access_token", ...}

note right of RP:JSON Document:\n{\n\n  "id_token": ADNqVMtqKeYp5w==...,\n  "access_token": xxx,\n  "email": "test@dashboard.cosri.app,\n  "attribute1": ...,\n  "attribute2": ...,\n   ...\n}

RP->RP: Verify id_token signature is valid, signed by OP


RP->UserAgent: 302 Redirect https:\/\/dashboard.cosri.app/
note over UserAgent: User is authenticated to https:\/\/dashboard.cosri.app
UserAgent->RP: GET https:\/\/dashboard.cosri.app/
RP->UserAgent: dashboard.cosri.app's page is displayed
